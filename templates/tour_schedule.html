{% extends 'base.html' %}
{% block title %}Upcoming Tours{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Upcoming College Tours</h2>

  <!-- Filters -->
  <form method="GET" action="{{ url_for('tours.tour_schedule') }}" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="school" placeholder="Search by school..." class="form-control" value="{{ request.args.get('school', '') }}">
    </div>
    <div class="col-md-4">
      <select name="status" class="form-select">
        <option value="">Filter by status</option>
        <option value="Available">Available</option>
        <option value="Confirmed">Confirmed</option>
        <option value="Full">Full</option>
        <option value="Tentative">Tentative</option>
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100">Apply Filters</button>
    </div>
  </form>

  <!-- Calendar -->
  <div id="calendar" style="max-width: 100%; margin: 0 auto;"></div>

  <!-- Tour Cards -->
  {% for tour in tours %}
  <div class="card my-3">
    <div class="card-body">
      <h5 class="card-title">{{ tour.title or "Untitled Tour" }}</h5>
      <p class="card-text">
        <strong>Date:</strong> {{ tour.date if tour.date else "TBD" }}<br>
        <strong>Status:</strong> {{ tour.status }}<br>
        <strong>Capacity:</strong> {{ tour.registered }}/{{ tour.capacity }}<br>
        {% if tour.schools %}
        <strong>Schools:</strong> {{ tour.schools | join(', ') }}
        {% endif %}
      </p>

      <form method="POST" action="{{ url_for('tours.reserve_tour', tour_id=tour._id) }}">
        <button class="btn btn-primary" type="submit">Reserve</button>
      </form>

      <!-- Modal Trigger -->
      <button class="btn btn-outline-info btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#tourModal{{ tour._id }}">Details</button>

      <!-- Modal -->
      <div class="modal fade" id="tourModal{{ tour._id }}" tabindex="-1" aria-labelledby="tourModalLabel{{ tour._id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tourModalLabel{{ tour._id }}">{{ tour.title or "Tour Details" }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p><strong>Date:</strong> {{ tour.date }}</p>
              <p><strong>Status:</strong> {{ tour.status }}</p>
              <p><strong>Schools:</strong> {{ tour.schools | join(', ') }}</p>
              {% if tour.details %}
              <p>{{ tour.details }}</p>
              {% endif %}
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <a href="{{ url_for('tours.reserve_tour', tour_id=tour._id) }}" class="btn btn-primary">Reserve Spot</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar Scripts -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: [
      {% for tour in tours %}
        {
          title: "{{ tour.title }} - {{ tour.schools | join(', ') }}",
          start: "{{ tour.date }}",
          allDay: true,
          color: {
            'Tentative': '#fff3cd',
            'Confirmed': '#cce5ff',
            'Available': '#d4edda',
            'Full': '#f8d7da'
          }["{{ tour.status }}"]
        },
      {% endfor %}
    ]
  });
  calendar.render();
});
</script>
{% endblock %}
